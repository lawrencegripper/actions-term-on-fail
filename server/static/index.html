<!DOCTYPE html>
<html data-color-mode="dark" data-dark-theme="dark">

<head>
  <title>Action Terminal</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='1.5'><rect x='2' y='3' width='20' height='14' rx='2'/><path d='M8 21h8M12 17v4'/><path d='M6 8l3 3-3 3M11 14h4' stroke='%233fb950'/></svg>">
  <link rel="stylesheet" href="https://unpkg.com/@primer/css@22.0.2/dist/primer.css">
  <link rel="stylesheet" href="/styles.css">
</head>

<body class="color-bg-default">
  <div id="vue-app"></div>

  <script type="text/x-template" id="app-template">
    <!-- Loading State -->
    <div v-if="isLoading" class="d-flex flex-column flex-items-center flex-justify-center" style="min-height: 100vh;">
      <div class="color-fg-muted">Loading...</div>
    </div>

    <!-- Login View -->
    <LoginView v-else-if="!isAuthenticated" />

    <!-- Authenticated App -->
    <template v-else>
      <!-- Main App -->
      <div id="app" :class="{ 'terminal-open': terminalOpen }">
        <div class="header-bar">
          <div class="header-logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b949e" stroke-width="1.5">
              <rect x="2" y="3" width="20" height="14" rx="2" />
              <path d="M8 21h8M12 17v4" />
              <path d="M6 8l3 3-3 3M11 14h4" stroke="#3fb950" />
            </svg>
            <span class="header-title">Action Terminal</span>
          </div>
          <div class="header-links">
            <a href="https://github.com/lawrencegripper/actions-term-on-fail" target="_blank" rel="noopener" title="GitHub">
              <svg width="20" height="20" viewBox="0 0 16 16" fill="#8b949e">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
              </svg>
            </a>
            <a href="https://blog.gripdev.xyz" target="_blank" rel="noopener" title="Blog" class="header-link-desktop">
              <svg width="20" height="20" viewBox="0 0 16 16" fill="#8b949e">
                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                <path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1m0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1"/>
              </svg>
            </a>
            <a href="https://fosstodon.org/@lawrencegripper" target="_blank" rel="noopener" title="Mastodon" class="header-link-desktop">
              <svg width="20" height="20" viewBox="0 0 16 16" fill="#8b949e">
                <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/>
              </svg>
            </a>
            <!-- SSE indicator in the header-links for proper alignment -->
            <div class="sse-indicator" :class="{ connected: sseConnected }">
              <div class="sse-spinner"></div>
              <span>Connected</span>
            </div>
          </div>
        </div>

        <StatusBanner 
          v-if="statusMessage"
          :message="statusMessage"
          :type="statusType"
          @new-session-click="onNewSessionClick"
          @enable-notifications="enableNotifications"
        />

        <div class="section-header">Active Sessions</div>

        <SessionList 
          :sessions="sessions"
          @select-session="promptOtp"
        />
      </div>

      <OtpModal
        :show="showOtpModal"
        :error="otpError"
        @submit="submitOtp"
        @cancel="cancelOtp"
      />

      <TerminalPanel
        :open="terminalOpen"
        :session-name="terminalSessionName"
        @close="closeTerminal"
      />
    </template>
  </script>

  <!-- Login Template -->
  <script type="text/x-template" id="login-template">
    <div class="d-flex flex-column flex-items-center flex-justify-center" style="min-height: 100vh;">
      <div class="header-bar" style="position: absolute; top: 0; left: 0; right: 0;">
        <div class="header-logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b949e" stroke-width="1.5">
            <rect x="2" y="3" width="20" height="14" rx="2" />
            <path d="M8 21h8M12 17v4" />
            <path d="M6 8l3 3-3 3M11 14h4" stroke="#3fb950" />
          </svg>
          <span class="header-title">Action Terminal</span>
        </div>
        <div class="header-links">
          <a href="https://github.com/lawrencegripper/actions-term-on-fail" target="_blank" rel="noopener" title="GitHub">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="#8b949e">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
          </a>
          <a href="https://blog.gripdev.xyz" target="_blank" rel="noopener" title="Blog" class="header-link-desktop">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="#8b949e">
              <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
              <path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1m0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1"/>
            </svg>
          </a>
          <a href="https://fosstodon.org/@lawrencegripper" target="_blank" rel="noopener" title="Mastodon" class="header-link-desktop">
            <svg width="20" height="20" viewBox="0 0 16 16" fill="#8b949e">
              <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/>
            </svg>
          </a>
        </div>
      </div>
      <div class="Box color-shadow-large p-5" style="max-width: 440px; width: 90%; border-radius: 12px;">
        <div class="text-center mb-4">
          <svg class="mb-3" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#8b949e" stroke-width="1.5">
            <rect x="2" y="3" width="20" height="14" rx="2" />
            <path d="M8 21h8M12 17v4" />
            <path d="M6 8l3 3-3 3M11 14h4" stroke="#3fb950" />
          </svg>
          <h1 class="h3 mt-2" style="color: #c9d1d9;">Action Terminal</h1>
          <p class="color-fg-muted f5 mt-2">Debug failed GitHub Actions in an interactive browser-based terminal.</p>
          <div class="color-fg-muted f6 mt-3" style="text-align: left; padding: 12px; background: #161b22; border-radius: 8px; border: 1px solid #30363d;">
            <div class="mb-2">✦ Drop-in GitHub Action for any workflow</div>
            <div class="mb-2">✦ Peer-to-Peer connection</div>
            <div>✦ <a href="https://github.com/coder/ghostty-web">Ghostty based</a> web terminal</div>
          </div>
          <a href="https://github.com/lawrencegripper/actions-term-on-fail?tab=readme-ov-file#architecture" target="_blank" rel="noopener" class="color-fg-muted f6 mt-3 d-inline-block" style="text-decoration: none;">
            → How does it work?
          </a>
        </div>
        <a href="https://github.com/lawrencegripper/actions-term-on-fail#readme" target="_blank" rel="noopener" class="btn btn-block mb-2" style="border-radius: 6px; background: #388bfd; color: white; border: none;">
          Setup Instructions
        </a>
        <a href="/auth/github" class="btn btn-primary btn-block" style="border-radius: 6px;">
          <svg class="octicon mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">
            <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" />
          </svg>
          <span class="d-none d-sm-inline">Sign in with GitHub to access your Terminals</span>
          <span class="d-sm-none">Sign in with GitHub</span>
        </a>
      </div>
    </div>
  </script>

  <!-- Status Banner Template -->
  <script type="text/x-template" id="status-banner-template">
    <div class="status-banner" :class="type" @click="handleClick">
      <!-- New Session -->
      <template v-if="message.type === 'new-session'">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0114.25 15H1.75A1.75 1.75 0 010 13.25Zm1.75-.25a.25.25 0 00-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V2.75a.25.25 0 00-.25-.25Z"/>
        </svg>
        New session: {{ message.session?.repo || 'Unknown' }} #{{ message.session?.runId || 'N/A' }} — Click to connect
      </template>
      <!-- Notification Prompt -->
      <template v-else-if="message.type === 'notification-prompt'">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 16a2 2 0 0 0 1.985-1.75c.017-.137-.097-.25-.235-.25h-3.5c-.138 0-.252.113-.235.25A2 2 0 0 0 8 16ZM8 1.5A3.5 3.5 0 0 0 4.5 5v2.947c0 .346-.102.683-.294.97l-1.703 2.556a.018.018 0 0 0-.003.01l.001.006c0 .002.002.004.004.006l.006.004.007.001h10.964l.007-.001.006-.004.004-.006.001-.007a.017.017 0 0 0-.003-.01l-1.703-2.554a1.745 1.745 0 0 1-.294-.97V5A3.5 3.5 0 0 0 8 1.5Z"/>
        </svg>
        Enable notifications to be alerted when a new session is available
      </template>
      <!-- Notification Enabled -->
      <template v-else-if="message.type === 'notification-enabled'">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/>
        </svg>
        Notifications enabled!
      </template>
      <!-- Generic -->
      <template v-else>{{ message }}</template>
    </div>
  </script>

  <!-- Session List Template -->
  <script type="text/x-template" id="session-list-template">
    <div id="sessions-list">
      <!-- Empty State -->
      <div v-if="isEmpty" class="empty-state">
        <svg class="empty-state-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="2" y="3" width="20" height="14" rx="2" />
          <path d="M8 21h8M12 17v4" />
        </svg>
        <div class="empty-state-title">No active sessions</div>
        <div class="empty-state-text">Start a workflow with the action to see it here.</div>
      </div>
      
      <!-- Session Items -->
      <div v-for="session in sessions" :key="session.runId" 
           class="session-item" @click="selectSession(session)">
        <div class="session-icon">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="white">
            <path d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0114.25 15H1.75A1.75 1.75 0 010 13.25Zm1.75-.25a.25.25 0 00-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V2.75a.25.25 0 00-.25-.25Z"/>
          </svg>
        </div>
        <div class="session-info">
          <div class="session-name">{{ session.repo || 'Unknown Repo' }}</div>
          <div class="session-meta">Run #{{ session.runId || 'N/A' }} • {{ formatTime(session.createdAt) }}</div>
        </div>
        <span class="session-badge">Online</span>
        <svg class="session-arrow" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path fill-rule="evenodd" d="M6.22 3.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 010-1.06z"/>
        </svg>
      </div>
    </div>
  </script>

  <!-- OTP Modal Template -->
  <script type="text/x-template" id="otp-modal-template">
    <div v-if="show" class="modal-overlay active">
      <div class="Box color-shadow-large anim-fade-in fast" style="max-width: 400px; width: 90%; border-radius: 12px;">
        <div class="Box-header" style="border-radius: 12px 12px 0 0; background: #161b22; border-bottom: 1px solid #30363d; padding: 16px;">
          <h2 class="Box-title" style="font-size: 16px; margin: 0;">Enter verification code</h2>
        </div>
        <div class="Box-body p-4" style="background: #0d1117;">
          <p class="color-fg-muted f6 mb-3">Enter the 6-digit code from your authenticator app.</p>
          <div v-if="error" class="flash flash-error mb-3" style="border-radius: 6px;">{{ error }}</div>
          <input type="text" ref="otpInput" class="form-control form-control-large input-block otp-input" 
                 maxlength="6" pattern="[0-9]*" inputmode="numeric" placeholder="000000" 
                 autocomplete="one-time-code" :value="otpCode" @input="onInput" @keypress="onKeypress"
                 style="border-radius: 6px; background: #161b22; border: 1px solid #30363d;">
        </div>
        <div class="Box-footer p-3" style="border-radius: 0 0 12px 12px; background: #161b22; border-top: 1px solid #30363d;">
          <div class="d-flex flex-justify-end gap-2">
            <button class="btn" type="button" @click="cancel" style="border-radius: 6px;">Cancel</button>
            <button class="btn btn-primary" type="button" @click="submit" :disabled="!isValid" style="border-radius: 6px;">Connect</button>
          </div>
        </div>
      </div>
    </div>
  </script>

  <!-- Terminal Panel Template -->
  <script type="text/x-template" id="terminal-panel-template">
    <div id="terminal-container" :class="{ open: open }">
      <div class="terminal-header">
        <div class="terminal-header-left">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="#8b949e">
            <path d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0114.25 15H1.75A1.75 1.75 0 010 13.25Zm1.75-.25a.25.25 0 00-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V2.75a.25.25 0 00-.25-.25Zm7.47 3.97a.75.75 0 011.06 0l2 2a.75.75 0 010 1.06l-2 2a.75.75 0 11-1.06-1.06L10.69 9 9.22 7.53a.75.75 0 010-1.06Zm-3.47 0a.75.75 0 010 1.06L4.31 9l1.47 1.47a.75.75 0 11-1.06 1.06l-2-2a.75.75 0 010-1.06l2-2a.75.75 0 011.06 0Z"/>
          </svg>
          <span class="terminal-title">{{ sessionName }}</span>
        </div>
        <button class="close-btn" @click="$emit('close')">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
            <path d="M3.72 3.72a.75.75 0 011.06 0L8 6.94l3.22-3.22a.75.75 0 111.06 1.06L9.06 8l3.22 3.22a.75.75 0 11-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 01-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 010-1.06z"/>
          </svg>
          Close
        </button>
      </div>
      <div id="terminal"></div>
    </div>
  </script>

  <!-- ============================================== -->
  <!-- APP INITIALIZATION -->
  <!-- ============================================== -->

  <script type="importmap">
    {
      "imports": {
        "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js"
      }
    }
  </script>

  <script type="module">
    import { initApp } from '/js/app.js';
    initApp().catch(err => console.error('Failed to initialize app:', err));
  </script>
</body>

</html>
