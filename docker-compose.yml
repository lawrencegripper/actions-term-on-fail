services:
  server:
    build: ./server
    ports:
      - "8080:8080"
    environment:
      - DEV_USER=testuser
      - DEV_MODE=true
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/"]
      interval: 2s
      timeout: 5s
      retries: 10

  client:
    build: ./client
    depends_on:
      server:
        condition: service_healthy
    environment:
      - SERVER_URL=http://server:8080
      - DEV_MODE=true
      - GITHUB_ACTOR=testuser
      - GITHUB_REPOSITORY=test/repo
      - GITHUB_RUN_ID=12345

  test:
    image: curlimages/curl:latest
    depends_on:
      server:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Waiting for client to register..."
        sleep 5
        
        echo "Testing session registration..."
        curl -s http://server:8080/api/sessions \
          -H "Cookie: token=test" | grep -q "unauthorized" && echo "Auth check passed"
        
        echo "Testing dev auth..."
        curl -s -c /tmp/cookies "http://server:8080/auth/github/callback?user=testuser" -L > /dev/null
        
        echo "Checking sessions for testuser..."
        SESSIONS=$$(curl -s -b /tmp/cookies http://server:8080/api/sessions)
        echo "Sessions: $$SESSIONS"
        
        if echo "$$SESSIONS" | grep -q "testuser"; then
          echo "✅ Integration test PASSED: Session found for testuser"
          exit 0
        else
          echo "❌ Integration test FAILED: No session found"
          exit 1
        fi
